var _dialog_msg = null;
var _dialog_msg_reprogramar = null;
var _diasDisponibles = null;
var _turnoReprogramar = null;
var _diasEspeciales  = null;
var _dialog_msg = null;
var _dialog_msg_consulta = null;
var _rechazdo_id = null;
$(function () {
    
    $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
     });
    
    function callBackSearch(){
        if(_dialog_msg != null){
            _dialog_msg.close();
        }
    }
    
    var table = $('#turnos-table').DataTable({
       
        processing: true,
        serverSide: true,
        responsive: true,
        lengthMenu: [30,60,90,120],
        language: {
            "lengthMenu": "_MENU_ por página",
            "zeroRecords": "No hay resultados",
            "info": "mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "(filtrando de _MAX_ registros totales)",
            "search": "Buscar",
            "paginate": {
                first:      "Primera",
                previous:   "Anterior",
                next:       "Siguiente",
                last:       "Ultima"
            },
        },
        dom: '<"top"Bf>rt<"bottom"lip><"clear">',
        buttons: [
            'csv', 'excel', 'print'
        ],
        scrollX: true,
        ajax: {
            url: "/turnos",
        },
        columns: [
            {data: 'nro_turno', name: 'nro_turno'},
            {data: 'hora_turno', name: 'hora_turno'},
            {data: 'fecha_turno', name: 'fecha_turno'},
            {data: function(d){
                    return (d.oficina == null ? '' : (d.oficina ? d.oficina.denominacion : ''))
            }, name:'oficina.denominacion'},
            {data: 'documento', name: 'documento'},
            {data: 'nombre', name: 'nombre'},
            {data: 'apellido', name: 'apellido'},
            {data: 'telefono', name: 'telefono'},
            {data: 'estado', name: 'estado'},
            {data: function(d){
                    return (d.oficina_id == null ? '' : (d.oficina_id ? d.oficina_id : ''))
            }, name:'oficina_id'},
            {data: 'localidad', name: 'localidad'},
            {data: 'action', name: 'action', orderable: true, searchable: false},
        ],
        columnDefs: [
                    {
                        "targets": [ 9 ],
                        "visible": false,
                        "searchable": true
                    },
                   
        ],
        drawCallback: function( settings ) {
                console.log('dibujar ', settings.json.recordsFiltered);
                $('#registros').html(settings.json.recordsFiltered);
                $('#total').html(settings.json.recordsTotal);
                callBackSearch();
        }
    });
   
    $('body').on('click', '.eliminarTurno', function () {
        var product_id = $(this).data("id");
        console.log($(this).data("id"));
        $.confirm({
            title: 'Advertencia',
            content: 'Desea eliminar el Turno seleccionado?',
            icon: 'mdi mdi-alert-circle '+'red',
            buttons: {
                aceptar: {
                    text: 'Eliminar',
                    btnClass: 'btn-success',
                    keys: ['enter', 'shift'],
                    action :function () {
                        $.ajax({
                            url: "turnos/eliminar/"+product_id,
                            method: 'DELETE',
                        }).done(function(data) {
                            if(data.status == 'success'){
                                showMsg('Información!', data.msg,'green');
                                table.draw();
                            }else{
                                showMsg('Advertencia!', data.msg,'red');
                            }
                        });
                    }
                },
                cancelar: {
                    text: 'Cancelar',
                    btnClass: 'btn-danger',
                    keys: ['enter', 'shift'],
                    action: function () {
                    
                    }
                },
              
            },
            
        });
    });
    $('body').on('click', '.rechazarTurno', function () {
        _rechazdo_id = $(this).data("id");
        console.log($(this).data("id"));
        $.confirm({
            title: 'Advertencia',
            content: 'Desea Rechazar el Turno seleccionado?',
            icon: 'mdi mdi-alert-circle '+'red',
            buttons: {
                aceptar: {
                    text: 'Rechazar',
                    btnClass: 'btn-success',
                    keys: ['enter', 'shift'],
                    action :function () {
                        $('#turno_observacion_cancelar').val('');
                        $('#cancelarModal').modal('show');
                        
                    }
                },
                cancelar: {
                    text: 'Cancelar',
                    btnClass: 'btn-danger',
                    keys: ['enter', 'shift'],
                    action: function () {
                    
                    }
                },
            
            },
            
        });
    });
    $(".select2").select2({
                width: '100%',
                allowClear: true,
                placeholder: {
                    id: '-1', // the value of the option
                    text: 'Seleccione una opción'
                },
                
           });
    $('.select2').on("select2:unselecting", function(e) {
        if(_dialog_msg){
            console.log('limpiando buscador');
            $('#btnBuscar').trigger('click');
        }
        
    });
    $('#btnBuscar').on('click',function(){
        position = 0;
        _dialog_msg = $.dialog({
                title: 'Filtrando Turnos...',
                content: 'Este proceso puede demorar unos segundos',
                closeIcon: false,
                theme: 'material'
        });
        table.columns().every( function () {
            if(position == 0 || position == 2 ||  position == 4 || position == 8 || position == 9 || position == 10 ){
                if(position == 0){
                    var data = this.data();
                    var column = this;
                    var val = $('#cbNroTurnos option:selected').text().trim();
                    column.search( val.trim() ? '^'+val.trim()+'$' : '', true, true );
                }else if(position == 2){
                    var data = this.data();
                    var column = this;
                    var val = $('#df_fecha_turno').val();
                    console.log('valor',val);
                    if(val == ''){
                        val = null;
                        column.search( val ? '^'+val+'$' : '', true, true );
                    }else{
                        var parseDate = val.split("/").reverse().join("-");
                        console.log('parse date ',parseDate);
                        column.search( parseDate.trim() ? '^'+parseDate.trim()+'$' : '', true, true );    
                    }
                }else if(position == 4){
                    var data = this.data();
                    var column = this;
                    var val = $('#cbDocumento option:selected').text().trim();
                    if(val == '-1'){
                        val = null;
                        column.search( val ? '^'+val+'$' : '', true, true );
                    }else{
                        column.search( val.trim() ? '^'+val.trim()+'$' : '', true, true );    
                    }
                }else if(position == 8){
                    var data = this.data();
                    var column = this;
                    var val = $('#cbEstado option:selected').text().trim();
                    if(val == '-1'){
                        val = null;
                        column.search( val ? '^'+val+'$' : '', true, true );
                    }else{
                        column.search( val.trim() ? '^'+val.trim()+'$' : '', true, true );    
                    }
                    
                }else if(position == 9){
                    var data = this.data();
                    var column = this;
                    var val = $('#cbOficina option:selected').val();
                    if(val == '-1'){
                        val = null;
                        column.search( val ? '^'+val+'$' : '', true, true );
                    }else{
                        column.search( val.trim() ? '^'+val.trim()+'$' : '', true, true );    
                    }
                }else if(position == 10){
                    var data = this.data();
                    var column = this;
                    var val = $('#cbLocalidad option:selected').val();
                    if(val == '-1'){
                        val = null;
                        column.search( val ? '^'+val+'$' : '', true, true );
                    }else{
                        column.search( val.trim() ? '^'+val.trim()+'$' : '', true, true );    
                    }
                }
            }
            position++;
        });
        table.draw();
    
    });
    $('#cbNroTurnos').select2({
        allowClear: true,
        placeholder: "Búsque por número",
        ajax: {
            url: '/turnos/buscar/filtro',
            data: function (params) {
                var query = {
                    search: params.term,
                    type: 'public'
                }
                return query;
            },
            processResults: function (data) {
                let result = [];
                for(let element of data){
                    result.push({
                        id: element.nro_turno,
                        text: element.nro_turno
                    })
                }
                console.log(result);
                return {
                    results: result
                };
            }
        }
    }).on('change', function() {
        $('#value')
            .removeClass('select2-offscreen')
            .select2({
                //data:data[$(this).val()],
                allowClear: true,
                placeholder: "Seleccione un número",
            });
    }).trigger('change'); 


    $('#cbDocumento').select2({
        allowClear: true,
        placeholder: "Búsque por documento",
        ajax: {
            url: '/turnos/buscar/filtro/documento',
            data: function (params) {
                var query = {
                    search: params.term,
                    type: 'public'
                }
                return query;
            },
            processResults: function (data) {
                let result = [];
                for(let element of data){
                    result.push({
                        id: element.documento,
                        text: element.documento
                    })
                }
                console.log(result);
                return {
                    results: result
                };
            }
        }
    }).on('change', function() {
        $('#value')
            .removeClass('select2-offscreen')
            .select2({
                //data:data[$(this).val()],
                allowClear: true,
                placeholder: "Seleccione un documento",
            });
    }).trigger('change'); 
});
$('#btnRechazarTurno').on('click', function(){
    $.confirm({
        title: 'Advertencia',
        content: 'Esta seguro que deseae rechazar el Turno '+$('#turno_cancelar').val(),
        icon: 'mdi mdi-alert-circle '+'red',
        buttons: {
            aceptar: {
                text: 'Aceptar',
                btnClass: 'btn-success',
                keys: ['enter', 'shift'],
                action :function () {
                    $.ajax({
                            url: "/turnos/rechazar/"+_rechazdo_id,
                            method: 'POST',
                            data: {observacion: $('#turno_observacion_cancelar').val()},
                        }).done(function(data) {
                            if(data.status == 'success'){
                                showMsg('Información!', data.msg,'green');
                                $('#cancelarModal').modal('toggle');
                                _rechazdo_id = null;
                                //table.draw();
                                $('#btnBuscar').click();
                            }else{
                                showMsg('Advertencia!', data.msg,'red');
                                $('#cancelarModal').modal('toggle');
                            }
                    });
                }
            },
            cancelar: {
                text: 'Cancelar',
                btnClass: 'btn-danger',
                keys: ['enter', 'shift'],
                action: function () {
                    $('#cancelarModal').modal('toggle');
                }
            },
        },
        
    });
});
//FUNCIONES DEL MODAL DE CONSULTA
$('#df_consulta').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});
$('#btnConsulta').on('click', function(){
let tramite_seleccionado = $('#cbTramiteConsulta').val();
let fecha_turno = $('#df_consulta').val();
if(tramite_seleccionado && fecha_turno){
    _dialog_msg_consulta = $.dialog({
        title: 'Consultado disponibilidad ...',
        content: 'Este proceso puede demorar unos segundos',
        closeIcon: false,
        theme: 'material'
    });
    $.post("sitio/consultar/disponibilidad/tramite/fecha",{tipo_tramite_id: tramite_seleccionado, fecha_turno: fecha_turno},
        function(data, status){
            if(_dialog_msg_consulta != null){
                _dialog_msg_consulta.close();
            }
            if(data.status == 'success'){
                $('#disponibles').html((data.data < 0 ) ? '0': data.data);
            }else{
                $('#disponibles').html('');
                showMsg('Advertencia', data.msg, 'red');
            }
        }
    );
}else{
    showMsg('Advertencia','Debe seleccionar el trámite y la fecha sobre la cuál desea consultar', 'red');
}
})
//FUNCIONES REPORTE MODAL

$('#df_consulta_reporte_desde').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});

$('#df_consulta_reporte_hasta').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});


$('#df_consulta_desde').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});

$('#df_consulta_hasta').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});

$('body').on('click', '.reprogramarTurno', function () {
_turno_reprogramar_id = $(this).data("id");
$.confirm({
    title: 'Advertencia',
    content: 'Desea reprogramar el Turno seleccionado?',
    icon: 'mdi mdi-alert-circle '+'red',
    buttons: {
        aceptar: {
            text: 'Si, Elegir Día',
            btnClass: 'btn-success',
            keys: ['enter', 'shift'],
            action :function () {
                _diasEspeciales = $.ajax({
                    url: "/sitio/obtener/dias/especiales",
                    dataTypa: "json",
                    method: "POST",
                    async: false,
                }).responseText;

                $.ajax({
                    url: "turnos/reprogramar/seleccionado/"+_turno_reprogramar_id,
                    method: 'POST',
                }).done(function(data) {
                    if(data.status == "success"){
                        _diasDisponibles = data.disponibles;
                        _turnoReprogramar = data.turno;
                        $("#turno_reprogramar_id").val(_turnoReprogramar.nro_turno);
                        $("#tituloRepo").text("Reprogramar Turno "+_turnoReprogramar.nro_turno);
                        initReprogramar(_turnoReprogramar.tipo_tramite_id);
                       
                    }else{
                        showMsg("Aviso", data.msg, "red");
                    }
                    
                });
                
            }
        },
        cancelar: {
            text: 'Cancelar',
            btnClass: 'btn-danger',
            keys: ['enter', 'shift'],
            action: function () {
                $("#turno_reprogramar_id").val("");
            }
        },
    
    },
    
});
});

function initReprogramar(tramite){
$("#fechaPicker").datepicker({
    selectOtherMonths: true,
    minDate: "+1d",
    maxDate: "+2m",
    dateFormat: "yy-mm-dd",
    firstDay: 1,
    monthNames: [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre",
    ],
    dayNamesMin: ["D", "L", "M", "M", "J", "V", "S"],
    altField: "#fechaTurno",
    altFormat: "yy-mm-dd",
    nextText: ">",
    prevText: "<",
    beforeShowDay: function (date) {
        var dia = jQuery.datepicker.formatDate("yy-mm-dd", date);
        var day = date.getDay();
        return  (_diasDisponibles.indexOf(dia) > -1) && (_diasEspeciales.indexOf(dia) == -1) ? [day != 0, ""] :  [false];
    },
    onSelect: function (date) {
        $.ajax({
            url: "/turnos/reprogramar/obtener/horarios/dia",
            method: "POST",
            data: { fecha_turno: date,  tramite: tramite },

            success: function (response) {
                $("#nuevo_horario").empty();
                let flag = false;
                let opcion = new Option('Seleccione un horario', "", false, false);
                $('#nuevo_horario').append(opcion);
                for(let item in response){
                    flag = true;
                    let opcion = new Option(response[item],response[item], false, false);
                    $('#nuevo_horario').append(opcion);
                }
                if(flag){
                    $(".errorHorario").hide();
                    $(".hasHorario").show('slow');
                }else{
                    $(".hasHorario").hide();
                    $(".errorHorario").show('slow');
                }
            },
        });
    }
});
$('#reprogramarModal').modal('show');
}

$('#btnConsultaReporte').on('click', function(){
let tramite_seleccionado = $('#cbTramiteConsultaReporte').val();
let fecha_desde = $('#df_consulta_desde').val();
let fecha_hasta = $('#df_consulta_hasta').val();


if((tramite_seleccionado && tramite_seleccionado != '-1') && fecha_desde && fecha_hasta ){
    _dialog_msg_consulta = $.dialog({
        title: 'Obteniendo información ...',
        content: 'Este proceso puede demorar unos segundos',
        closeIcon: false,
        theme: 'material'
    });
    let params = {tipo_tramite_id: tramite_seleccionado, fecha_desde: fecha_desde, fecha_hasta: fecha_hasta};
    $.ajax({
        xhrFields: {
            responseType: 'blob',
        },
        type: 'POST',
        url: 'turnos/generar/reporte/tramite/',
        data: params,
        success: function(result, status, xhr) {
            if(_dialog_msg_consulta != null){
                _dialog_msg_consulta.close();
            }
            var blob = new Blob([result], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });
            var link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'reporte';

            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
        }
    });
   
}else{
    showMsg('Advertencia','Debe seleccionar el trámite y las fechas sobre la cuál desea consultar', 'red');
}
});

$('#df_fecha_turno').datepicker({
uiLibrary: 'bootstrap4',
format: 'dd/mm/yyyy',
locale: 'es-es',
});

$("#btnAsignarReprogramacion").on("click", function(){
if($("#nuevo_horario").val() && $("#fechaTurno").val()){
    let params = {
        horario: $("#nuevo_horario").val(),
        fecha: $("#fechaTurno").val()
    }
    _dialog_msg_reprogramar = $.dialog({
        title: 'Reprogramando turno ...',
        content: 'Este proceso puede demorar unos segundos',
        closeIcon: false,
        theme: 'material'
    });

    $.ajax({
        url: "/turnos/reprogramar/confirmar/seleccion/dia/"+$("#turno_reprogramar_id").val(),
        method: "POST",
        data: params,
        success: function (response) {
            if(response.status == "success"){
                if(_dialog_msg_reprogramar != null){
                    _dialog_msg_reprogramar.close();
                }
                $("#nuevo_horario").empty();
                $("#fechaTurno").val("")
                $("#turno_reprogramar_id").val("");
                $("#tituloRepo").text("");
                $('#btnBuscar').trigger("click");
                $('#reprogramarModal').modal('toggle');
            }else{
                if(_dialog_msg_reprogramar != null){
                    _dialog_msg_reprogramar.close();
                }
                showMsg('Aviso!', data.msg ,'red');
            }
        },
    });
}else{
    showMsg('Aviso!', "Debe seleccionar un día y un horario",'red');
}
})
